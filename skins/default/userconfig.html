<load target="../../../member/skins/default/css/member.css" />
<load target="css/default.css" />
<include target="../../../member/skins/default/common_header.html" cond="!$force_use_otp || ($force_use_otp && $user_config->use === 'Y')" />
<div class="xm">
    <div cond="$XE_VALIDATOR_MESSAGE && $XE_VALIDATOR_ID == 'modules/googleotp/tpl/otp/otpconfig/1'" class="message {$XE_VALIDATOR_MESSAGE_TYPE}">
        <p>{$XE_VALIDATOR_MESSAGE}</p>
    </div>
    <div class="message error" cond="$force_use_otp && $user_config->use !== 'Y'">
        <p>사이트 정책으로 활동하시기 전 반드시 2차 인증을 사용 설정하셔야 합니다.</p>
    </div>
    <form action="./" method="post" class="form-horizontal" id="fo_otpconfig">
        <input type="hidden" name="module" value="googleotp" />
        <input type="hidden" name="act" value="procGoogleotpUserConfig" />
        <input type="hidden" name="xe_validator_id" value="modules/googleotp/tpl/otp/otpconfig/1" />
        <input type="hidden" name="error_return_url" value="{getRequestUriByServerEnviroment()}" />
        <input type="hidden" name="member_srl" value="{$member_srl}">
        <section class="section">
            <h1>로그인 2차 인증 설정</h1>
            <div class="control-group">
                <label class="control-label">로그인시 2차 인증 사용하기</label>
                <div class="controls">
                    <label class="inline">
                        <input type="radio" name="use" id="use_tfa" value="Y" checked="checked"|cond="$user_config->use == 'Y' || $force_use_otp" /> 사용함
                    </label>
                    <label class="inline">
                        <input type="radio" name="use" id="no_use_tfa" value="N" checked="checked"|cond="$user_config->use != 'Y' && !$force_use_otp" disabled="disabled"|cond="$force_use_otp" /> 사용하지 않음
                    </label>
                    <p class="help-block" cond="$force_use_otp">사이트 정책으로 2차 인증 비활성화가 불가능합니다.</p>
                    <p class="help-block" cond="!$force_use_otp">로그인시에 2차 인증을 통해 보안을 강화합니다.</p>
                </div>
            </div>
            <div id="tfa_enabled" style="display:none"|cond="$user_config->use != 'Y' && !$force_use_otp">
                <hr><br>
                <div class="control-group">
                    <label class="control-label">2차 인증 방식 (복수 선택 가능)</label>
                    <div class="controls">
                        <!--@if(in_array('otp', $googleotp_config->allow_issue_type))-->
                        <label class="inline">
                            <input type="checkbox" name="issue_type[]" id="auth_otp" value="otp" checked="checked"|cond="in_array('otp', explode(',', $user_config->issue_type))" /> Google OTP
                        </label>
                        <!--@endif-->

                        <!--@if(in_array('email', $googleotp_config->allow_issue_type))-->
                        <label class="inline">
                            <input type="checkbox" name="issue_type[]" id="auth_email" value="email" checked="checked"|cond="in_array('email', explode(',', $user_config->issue_type))" /> 이메일 인증
                        </label>
                        <!--@endif-->

                        <!--@if(in_array('sms', $googleotp_config->allow_issue_type))-->
                        <label class="inline">
                            <input type="checkbox" name="issue_type[]" id="auth_sms" value="sms" checked="checked"|cond="in_array('sms', explode(',', $user_config->issue_type))" /> SMS 인증
                        </label>
                        <!--@endif-->

                        <!--@if(in_array('passkey', $googleotp_config->allow_issue_type))-->
                        <label class="inline">
                            <input type="checkbox" name="issue_type[]" id="auth_passkey" value="passkey" checked="checked"|cond="in_array('passkey', explode(',', $user_config->issue_type))" /> 패스키 (Passkey)
                        </label>
                        <!--@endif-->
                        <p class="help-block">사용할 인증 방식을 선택해주세요. 여러 개를 선택하면 로그인 시 다른 방식으로 전환할 수 있습니다.</p>
                    </div>
                </div>
                <div class="control-group" id="default_issue_type_group">
                    <label class="control-label">기본 인증 방식</label>
                    <div class="controls">
                        <select name="default_issue_type" id="default_issue_type">
                            <!--@if(in_array('otp', $googleotp_config->allow_issue_type))-->
                            <option value="otp" selected="selected"|cond="($user_config->default_issue_type ?: explode(',', $user_config->issue_type)[0]) == 'otp'">Google OTP</option>
                            <!--@endif-->
                            <!--@if(in_array('email', $googleotp_config->allow_issue_type))-->
                            <option value="email" selected="selected"|cond="($user_config->default_issue_type ?: explode(',', $user_config->issue_type)[0]) == 'email'">이메일 인증</option>
                            <!--@endif-->
                            <!--@if(in_array('sms', $googleotp_config->allow_issue_type))-->
                            <option value="sms" selected="selected"|cond="($user_config->default_issue_type ?: explode(',', $user_config->issue_type)[0]) == 'sms'">SMS 인증</option>
                            <!--@endif-->
                            <!--@if(in_array('passkey', $googleotp_config->allow_issue_type))-->
                            <option value="passkey" selected="selected"|cond="($user_config->default_issue_type ?: explode(',', $user_config->issue_type)[0]) == 'passkey'">패스키 (Passkey)</option>
                            <!--@endif-->
                        </select>
                        <p class="help-block">로그인 시 기본으로 사용할 인증 방식을 선택해주세요.</p>
                    </div>
                </div>
                <div id="google_otp_help-block" style="display:none"|cond="!in_array('otp', explode(',', $user_config->issue_type))">
                    <p>주의 : 하단의 QR코드를 휴대폰에서 인식하여 Google OTP에 사이트를 추가해주세요.</p>
                </div>
                <div id="email_auth_help-block" style="display:none"|cond="!in_array('email', explode(',', $user_config->issue_type))">
                    <p>주의 : 다음 로그인부터 해당 이메일({$user_mail})로 인증 메일이 발송됩니다.</p>
                </div>
                <div id="sms_auth_help-block" style="display:none"|cond="!in_array('sms', explode(',', $user_config->issue_type))">
                    <p>주의 : 다음 로그인부터 해당 전화번호({$user_phone})로 인증 메세지가 발송됩니다.</p>
                </div>
                <div id="passkey_auth_help-block" style="display:none"|cond="!in_array('passkey', explode(',', $user_config->issue_type))">
                    <p>패스키를 등록하면 지문, 얼굴 인식, 보안 키 등으로 2차 인증을 할 수 있습니다.</p>
                </div>
                <div class="control-group" id="google_otp_qr" style="display:none"|cond="!in_array('otp', explode(',', $user_config->issue_type))">
                    <label class="control-label">Google OTP QR코드</label>
                    <div class="controls">
                        <img src="{$user_config->qrcode}" />
                        <p class="help-block">Google OTP에 등록할 때 사용할 QR코드입니다 외부로 유출되지 않도록 아이디 및 절대 이 QR코드를 저장하지 마세요.</p>
                    </div>
                </div>
                <div class="control-group" id="google_otp_input" style="display:none"|cond="!in_array('otp', explode(',', $user_config->issue_type))">
                    <label class="control-label">확인용 인증코드</label>
                    <div class="controls">
                        <input type="number" name="test_auth_key" value="" />
                        <p class="help-block">위 QR코드를 사용해 Google OTP를 등록한 뒤 표시되는 인증코드를 입력해주세요.</p>
                    </div>
                </div>
            </div>
        </section>
        <!--@if(in_array('passkey', $googleotp_config->allow_issue_type))-->
        <section class="section" id="passkey_section">
            <h1>패스키 관리</h1>
            <div class="control-group">
                <div class="controls">
                    <div style="margin-bottom:10px;">
                        <input type="text" id="passkey_name" placeholder="패스키 이름 (예: 내 노트북)" style="margin-right:5px;" />
                        <button type="button" class="btn btn-primary" id="btn_register_passkey" onclick="registerPasskey()">새 패스키 등록</button>
                    </div>
                    <p class="help-block" id="passkey_status"></p>

                    <!--@if($passkey_list && count($passkey_list) > 0)-->
                    <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                        <thead>
                        <tr style="border-bottom:2px solid #ddd;">
                            <th style="padding:8px; text-align:left;">패스키 이름</th>
                            <th style="padding:8px; text-align:left;">등록일</th>
                            <th style="padding:8px; text-align:center;">관리</th>
                        </tr>
                        </thead>
                        <tbody>
                            <!--@foreach($passkey_list as $pk)-->
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:8px;">{$pk->key_name}</td>
                                <td style="padding:8px;">{date('Y-m-d H:i', $pk->created_at)}</td>
                                <td style="padding:8px; text-align:center;">
                                    <button type="button" class="btn btn-danger btn-small" onclick="deletePasskey({$pk->idx})">삭제</button>
                                </td>
                            </tr>
                            <!--@end-->
                        </tbody>
                    </table>
                    <!--@else-->
                    <p style="margin-top:10px; color:#888;">등록된 패스키가 없습니다.</p>
                    <!--@endif-->
                </div>
            </div>
        </section>
        <!--@endif-->
        <div class="clearfix btnArea">
            <div class="pull-right">
                <button class="btn btn-primary" type="submit">설정 저장</button>
            </div>
            <div class="pull-left" cond="$googleotp_config->use_trusted_device == 'Y'">
                <a class="btn" href="{getUrl('', 'act', 'dispGoogleotpTrustedDevices')}">신뢰할 수 있는 기기 관리</a>
            </div>
        </div>
    </form>
</div>
<load target="../../vendor/davidearl/webauthn/src/webauthnregister.js" />
<script>
$('#use_tfa').click(function(){
    $('#tfa_enabled').show();
});
$('#no_use_tfa').click(function(){
    $('#tfa_enabled').hide();
});

function updateAuthHelpBlocks() {
    var otpChecked = $('#auth_otp').is(':checked');
    var emailChecked = $('#auth_email').is(':checked');
    var smsChecked = $('#auth_sms').is(':checked');
    var passkeyChecked = $('#auth_passkey').is(':checked');

    $('#google_otp_help-block').toggle(otpChecked);
    $('#google_otp_qr').toggle(otpChecked);
    $('#google_otp_input').toggle(otpChecked);
    $('#email_auth_help-block').toggle(emailChecked);
    $('#sms_auth_help-block').toggle(smsChecked);
    $('#passkey_auth_help-block').toggle(passkeyChecked);

    updateDefaultIssueType();
}

function updateDefaultIssueType() {
    var checkedTypes = [];
    $('input[name="issue_type[]"]:checked').each(function(){
        checkedTypes.push($(this).val());
    });

    $('#default_issue_type option').each(function(){
        var optVal = $(this).val();
        if(checkedTypes.indexOf(optVal) >= 0) {
            $(this).prop('disabled', false).show();
        } else {
            $(this).prop('disabled', true).hide();
        }
    });

    // 현재 선택된 기본 방식이 비활성화된 경우 첫 번째 활성화된 방식으로 변경
    var currentDefault = $('#default_issue_type').val();
    if(checkedTypes.indexOf(currentDefault) < 0 && checkedTypes.length > 0) {
        $('#default_issue_type').val(checkedTypes[0]);
    }

    // 선택된 인증 방식이 없으면 기본 방식 선택 숨기기
    if(checkedTypes.length <= 1) {
        $('#default_issue_type_group').hide();
    } else {
        $('#default_issue_type_group').show();
    }
}

$('#auth_otp').change(updateAuthHelpBlocks);
$('#auth_email').change(updateAuthHelpBlocks);
$('#auth_sms').change(updateAuthHelpBlocks);
$('#auth_passkey').change(updateAuthHelpBlocks);

// 초기 상태 설정
$(document).ready(function(){
    updateAuthHelpBlocks();
});

function registerPasskey(){
    if(!window.PublicKeyCredential){
        alert('이 브라우저는 패스키를 지원하지 않습니다.');
        return;
    }
    $('#passkey_status').text('패스키 등록 준비 중...').css('color', '');
    exec_json("googleotp.procGoogleotpPasskeyRegisterChallenge", {}, function(data){
        if(data.error != 0){
            $('#passkey_status').text(data.message).css('color', 'red');
            return;
        }
        var challenge = data.challenge;
        $('#passkey_status').text('보안 키를 터치하거나 생체 인증을 진행해주세요...').css('color', '');
        webauthnRegister(challenge, function(success, info){
            if(success){
                exec_json("googleotp.procGoogleotpPasskeyRegister", {passkey_info: info, key_name: $('#passkey_name').val() || 'Passkey'}, function(regData){
                    if(regData.error != 0){
                        $('#passkey_status').text(regData.message).css('color', 'red');
                    } else {
                        $('#passkey_status').text('패스키가 등록되었습니다!').css('color', 'green');
                        setTimeout(function(){ location.reload(); }, 1000);
                    }
                });
            } else {
                if(info === 'abort'){
                    $('#passkey_status').text('패스키 등록이 취소되었습니다.').css('color', '#888');
                } else {
                    $('#passkey_status').text('패스키 등록 오류: ' + info).css('color', 'red');
                }
            }
        });
    });
}

function deletePasskey(passkey_idx){
    if(!confirm('이 패스키를 삭제하시겠습니까?')) return;
    exec_json("googleotp.procGoogleotpDeletePasskey", {passkey_idx: passkey_idx}, function(data){
        if(data.error != 0){
            alert(data.message);
        } else {
            location.reload();
        }
    });
}
</script>
<include target="../../../member/skins/default/common_footer.html" cond="!$force_use_otp || ($force_use_otp && $user_config->use == 'Y')" />
